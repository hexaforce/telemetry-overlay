<!doctype html>
<html lang="en">
  <head>
    <title>Absolute orientation sensor demo</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <style>
      body {
        margin: 0px;
        overflow: hidden;
      }
      #phone {
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      #requestPermission {
        display: none;
        padding: 10px 20px;
        font-size: 16px;
      }
    </style>
  </head>

  <body>
    <script src="js/three.min.js"></script>
    <script src="js/OBJLoader.js"></script>
    <script src="js/MTLLoader.js"></script>

    <script type="module">
      import { AbsoluteOrientationSensor, RelativeOrientationSensor } from '../sensor-polyfills/motion-sensors.js'

      const params = new URLSearchParams(new URL(window.location.href).search.slice(1))
      const relative = !!Number(params.get('relative'))
      const coordinateSystem = params.get('coord')

      let requestPermission = document.querySelector('button#requestPermission')

      function isIOS() {
        return ['iPad Simulator', 'iPhone Simulator', 'iPod Simulator', 'iPad', 'iPhone', 'iPod'].includes(navigator.platform) || (navigator.userAgent.includes('Mac') && navigator.maxTouchPoints > 1)
      }
      if (isIOS()) requestPermission.style.display = 'block'

      let sensor, camera, scene, renderer, model

      initScene()
      initSensor()
      renderScene()

      function initScene() {
        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 200)
        camera.position.z = 10

        scene = new THREE.Scene()
        scene.add(new THREE.AmbientLight(0x404040, 6))

        var manager = new THREE.LoadingManager()
        var mtlLoader = new THREE.MTLLoader(manager)
        mtlLoader.setTexturePath('resources/')
        mtlLoader.load('resources/phone.mtl', (materials) => {
          materials.preload()
          var objLoader = new THREE.OBJLoader(manager)
          objLoader.setMaterials(materials)
          objLoader.load('resources/phone.obj', (object) => {
            model = object
            scene.add(model)
          })
        })

        renderer = new THREE.WebGLRenderer({ alpha: true })
        renderer.setPixelRatio(window.devicePixelRatio)
        renderer.setSize(window.innerWidth, window.innerHeight)
        document.querySelector('div#phone').appendChild(renderer.domElement)

        window.addEventListener(
          'resize',
          () => {
            camera.aspect = window.innerWidth / window.innerHeight
            camera.updateProjectionMatrix()
            renderer.setSize(window.innerWidth, window.innerHeight)
          },
          false,
        )
      }

      function initSensor() {
        const options = { frequency: 60, coordinateSystem }
        console.log(JSON.stringify(options))
        sensor = relative ? new RelativeOrientationSensor(options) : new AbsoluteOrientationSensor(options)
        sensor.onreading = () => {
          if (model) model.quaternion.fromArray(sensor.quaternion).inverse()
        }
        sensor.onerror = (event) => {
          if (event.error.name == 'NotReadableError') {
            console.log('Sensor is not available.')
          }
        }
        sensor.start()
      }

      function renderScene() {
        requestAnimationFrame(renderScene)
        camera.lookAt(scene.position)
        renderer.render(scene, camera)
      }

      requestPermission.onclick = async () => {
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
          let permissionState = await DeviceMotionEvent.requestPermission()
          if (permissionState === 'granted') {
            console.log('Motion permission granted!')
          } else {
            console.log('Motion permission denied.')
          }
        }
      }
    </script>
    <div id="phone"></div>
    <div id="console"></div>
    <button id="requestPermission">Request Permission</button>
  </body>
</html>

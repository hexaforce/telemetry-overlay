<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <script type="module" type="text/javascript">

    'use strict'

    /* globals MediaRecorder */

    let mediaRecorder
    let recordedBlobs

    const codecPreferences = document.querySelector('#codecPreferences')

    const errorMsgElement = document.querySelector('span#errorMsg')
    const recordedVideo = document.querySelector('video#recorded')

    const recordButton = document.querySelector('button#record')
    const playButton = document.querySelector('button#play')
    const downloadButton = document.querySelector('button#download')

    recordButton.onclick = async () => {
      if (recordButton.textContent === 'Start Recording') {
        startRecording()
      } else {
        mediaRecorder.stop()
        recordButton.textContent = 'Start Recording'
        playButton.disabled = false
        downloadButton.disabled = false
        codecPreferences.disabled = false
      }
    }

    playButton.onclick = async () => {
      const mimeType = codecPreferences.options[codecPreferences.selectedIndex].value.split(';', 1)[0]
      const superBuffer = new Blob(recordedBlobs, { type: mimeType })
      recordedVideo.src = null
      recordedVideo.srcObject = null
      recordedVideo.src = window.URL.createObjectURL(superBuffer)
      recordedVideo.controls = true
      recordedVideo.play()
    }

    downloadButton.onclick = async () => {
      const mimeType = codecPreferences.options[codecPreferences.selectedIndex].value.split(';', 1)[0]
      const blob = new Blob(recordedBlobs, { type: mimeType })
      const url = window.URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.style.display = 'none'
      a.href = url
      a.download = `test.${mimeTypeToFileExtension(mimeType)}`
      document.body.appendChild(a)
      a.click()
      setTimeout(() => {
        document.body.removeChild(a)
        window.URL.revokeObjectURL(url)
      }, 100)
    }

    function mimeTypeToFileExtension(mimeType) {
      switch (mimeType) {
        case 'video/mp4':
          return 'mp4'
        case 'video/webm':
          return 'webm'
        case 'video/x-matroska':
          return 'mkv'
        default:
          throw new Error(`unsupported mimetype: ${mimeType}`)
      }
    }

    async function startRecording() {
      recordedBlobs = []
      const mimeType = codecPreferences.options[codecPreferences.selectedIndex].value

      if (mimeType.split(';', 1)[0] === 'video/mp4') {
        // Adjust sampling rate to 48khz.
        const track = window.stream.getAudioTracks()[0]
        if (track) {
          const { sampleRate } = track.getSettings()
          if (sampleRate != 48000) {
            track.stop()
            window.stream.removeTrack(track)
            const newStream = await navigator.mediaDevices.getUserMedia({ audio: { sampleRate: 48000 } })
            window.stream.addTrack(newStream.getTracks()[0])
          }
        }
      }

      mediaRecorder = new MediaRecorder(window.stream, { mimeType })

      recordButton.textContent = 'Stop Recording'
      playButton.disabled = true
      downloadButton.disabled = true
      codecPreferences.disabled = true

      mediaRecorder.onstop = (event) => {
        console.log('Recorder stopped: ', event)
        console.log('Recorded Blobs: ', recordedBlobs)
      }
      mediaRecorder.ondataavailable = (event) => {
        if (event.data && event.data.size > 0) {
          recordedBlobs.push(event.data)
        }
      }
      mediaRecorder.start()
    }

    async function onStart(stream) {
      document.querySelector('button#start-gum').disabled = true
      document.querySelector('button#start-gdm').disabled = true
      try {
        recordButton.disabled = false
        console.log('Got stream:', stream)
        window.stream = stream
        const gumVideo = document.querySelector('video#gum')
        gumVideo.srcObject = stream
        const SupportedType = [
          'video/webm;codecs=vp9,opus',
          'video/webm;codecs=vp8,opus',
          'video/webm;codecs=h264,opus',
          'video/webm;codecs=av01,opus',
          'video/x-matroska;codecs=hvc1.1.6.L186.B0,opus',
          'video/mp4;codecs=vp9,mp4a.40.2',
          'video/mp4;codecs=vp9,opus',
          'video/mp4;codecs=avc1.64003E,mp4a.40.2',
          'video/mp4;codecs=avc1.64003E,opus',
          'video/mp4;codecs=avc3.64003E,mp4a.40.2',
          'video/mp4;codecs=avc3.64003E,opus',
          'video/mp4;codecs=hvc1.1.6.L186.B0,mp4a.40.2',
          'video/mp4;codecs=hvc1.1.6.L186.B0,opus',
          'video/mp4;codecs=hev1.1.6.L186.B0,mp4a.40.2',
          'video/mp4;codecs=hev1.1.6.L186.B0,opus',
          'video/mp4;codecs=av01.0.19M.08,mp4a.40.2',
          'video/mp4;codecs=av01.0.19M.08,opus',
          'video/mp4',
        ].filter((mimeType) => MediaRecorder.isTypeSupported(mimeType))
        SupportedType.forEach((mimeType) => {
          const option = document.createElement('option')
          option.value = mimeType
          option.innerText = option.value
          codecPreferences.appendChild(option)
        })
        codecPreferences.disabled = false
      } catch (e) {
        console.error('Source open error:', e)
        errorMsgElement.innerHTML = `Source error: ${e.toString()}`
      }
    }

    document.querySelector('button#start-gum').addEventListener('click', async () => {
      const constraints = {
        audio: { echoCancellation: document.querySelector('#echoCancellation').checked },
        video: { width: 1280, height: 720 },
      }
      const stream = await navigator.mediaDevices.getUserMedia(constraints)
      await onStart(stream)
    })
    document.querySelector('button#start-gdm').addEventListener('click', async () => {
      const constraints = {
        audio: { echoCancellation: document.querySelector('#echoCancellation').checked },
        video: { width: 1280, height: 720 },
      }
      const stream = await navigator.mediaDevices.getDisplayMedia(constraints)
      await onStart(stream)
    })

  </script>
</head>

<body>
  <div id="container">
    <video id="gum" playsinline autoplay muted></video>
    <video id="recorded" playsinline loop></video>
    <div>
      <button id="start-gum">Start camera</button>
      <button id="start-gdm">Start screenshare</button>
      <button id="record" disabled>Start Recording</button>
      <button id="play" disabled>Play</button>
      <button id="download" disabled>Download</button>
    </div>
    <div>
      Recording format:
      <select id="codecPreferences" disabled></select>
    </div>
    <div>
      <h4>Media Stream Constraints options</h4>
      <p>Echo cancellation: <input type="checkbox" id="echoCancellation" /></p>
    </div>
    <div>
      <span id="errorMsg"></span>
    </div>
  </div>
</body>

</html>
<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <script type="module" type="text/javascript">

    'use strict'

    const dimensions = document.querySelector('#dimensions')
    const video = document.querySelector('video')
    let stream

    const qvgaButton = document.querySelector('#qvga')
    const p180Button = document.querySelector('#p180')
    const vgaButton = document.querySelector('#vga')
    const p360Button = document.querySelector('#p360')
    const hdButton = document.querySelector('#hd')
    const fullHdButton = document.querySelector('#full-hd')
    const cinemaFourKButton = document.querySelector('#cinemaFourK')
    const televisionFourKButton = document.querySelector('#televisionFourK')
    const eightKButton = document.querySelector('#eightK')

    const videoblock = document.querySelector('#videoblock')
    const messagebox = document.querySelector('#errormessage')

    const widthInput = document.querySelector('div#width input')
    const widthOutput = document.querySelector('div#width span')
    const aspectLock = document.querySelector('#aspectlock')
    const sizeLock = document.querySelector('#sizelock')
    const pauseVideo = document.querySelector('#pausevideo')

    const videoSelect = document.querySelector('select#videoSource')

    // function gotDevices

    navigator.mediaDevices.enumerateDevices().then((deviceArray) => {
      // Handles being called several times to update labels. Preserve values.
      while (videoSelect.firstChild) {
        videoSelect.removeChild(videoSelect.firstChild)
      }
      deviceArray.reverse()
      for (let i = 0; i !== deviceArray.length; ++i) {
        const { deviceId, kind, label } = deviceArray[i]
        if (kind === 'videoinput') {
          const option = document.createElement('option')
          option.value = deviceId
          option.text = label || `camera ${videoSelect.length + 1}`
          videoSelect.appendChild(option)
        }
      }
    })

    let currentWidth = 0
    let currentHeight = 0

    function getMedia(constraints) {
      if (stream) {
        stream.getTracks().forEach((track) => {
          track.stop()
        })
      }

      clearErrorMessage()
      videoblock.style.display = 'none'
      constraints.video.deviceId = { ideal: videoSelect.value }
      console.log('getUserMedia constraints: ' + JSON.stringify(constraints))
      navigator.mediaDevices
        .getUserMedia(constraints)
        .then(gotStream)
        .catch((e) => {
          errorMessage('getUserMedia', e.message, e.name)
        })
    }

    p180Button.onclick = () => {
      getMedia({ video: { width: { exact: 320 }, height: { exact: 180 } } })
    }

    qvgaButton.onclick = () => {
      getMedia({ video: { width: { exact: 320 }, height: { exact: 240 } } })
    }

    p360Button.onclick = () => {
      getMedia({ video: { width: { exact: 640 }, height: { exact: 360 } } })
    }

    vgaButton.onclick = () => {
      getMedia({ video: { width: { exact: 640 }, height: { exact: 480 } } })
    }

    hdButton.onclick = () => {
      getMedia({ video: { width: { exact: 1280 }, height: { exact: 720 } } })
    }

    fullHdButton.onclick = () => {
      getMedia({ video: { width: { exact: 1920 }, height: { exact: 1080 } } })
    }

    televisionFourKButton.onclick = () => {
      getMedia({ video: { width: { exact: 3840 }, height: { exact: 2160 } } })
    }

    cinemaFourKButton.onclick = () => {
      getMedia({ video: { width: { exact: 4096 }, height: { exact: 2160 } } })
    }

    eightKButton.onclick = () => {
      getMedia({ video: { width: { exact: 7680 }, height: { exact: 4320 } } })
    }

    pauseVideo.onchange = () => {
      pauseVideo.checked ? video.pause() : video.play()
    }

    function gotStream(mediaStream) {
      stream = window.stream = mediaStream // stream available to console
      video.srcObject = mediaStream
      messagebox.style.display = 'none'
      videoblock.style.display = 'block'
      const track = mediaStream.getVideoTracks()[0]
      const constraints = track.getConstraints()
      console.log('Result constraints: ' + JSON.stringify(constraints))
      if (constraints && constraints.width && constraints.width.exact) {
        widthInput.value = constraints.width.exact
        widthOutput.textContent = constraints.width.exact
      } else if (constraints && constraints.width && constraints.width.min) {
        widthInput.value = constraints.width.min
        widthOutput.textContent = constraints.width.min
      }
    }

    function errorMessage(who, what) {
      const message = who + ': ' + what
      messagebox.innerText = message
      messagebox.style.display = 'block'
      console.log(message)
    }

    function clearErrorMessage() {
      messagebox.style.display = 'none'
    }

    function displayVideoDimensions(whereSeen) {
      if (video.videoWidth) {
        dimensions.innerText = 'Actual video dimensions: ' + video.videoWidth + 'x' + video.videoHeight + 'px.'
        if (currentWidth !== video.videoWidth || currentHeight !== video.videoHeight) {
          console.log(whereSeen + ': ' + dimensions.innerText)
          currentWidth = video.videoWidth
          currentHeight = video.videoHeight
        }
      } else {
        dimensions.innerText = 'Video not ready'
      }
    }

    video.onloadedmetadata = () => {
      displayVideoDimensions('loadedmetadata')
    }

    video.onresize = () => {
      displayVideoDimensions('resize')
    }

    function constraintChange(e) {
      widthOutput.textContent = e.target.value
      const track = window.stream.getVideoTracks()[0]
      let constraints
      if (aspectLock.checked) {
        constraints = {
          width: { exact: e.target.value },
          aspectRatio: {
            exact: video.videoWidth / video.videoHeight,
          },
        }
      } else {
        constraints = { width: { exact: e.target.value } }
      }
      clearErrorMessage()
      console.log('applying ' + JSON.stringify(constraints))
      track
        .applyConstraints(constraints)
        .then(() => {
          console.log('applyConstraint success')
          displayVideoDimensions('applyConstraints')
        })
        .catch((err) => {
          errorMessage('applyConstraints', err.name)
        })
    }

    widthInput.onchange = constraintChange

    sizeLock.onchange = () => {
      if (sizeLock.checked) {
        console.log('Setting fixed size')
        video.style.width = '100%'
      } else {
        console.log('Setting auto size')
        video.style.width = 'auto'
      }
    }

  </script>
</head>

<body>
  <div id="container">
    <div class="select">
      <label for="videoSource">Video source: </label><select id="videoSource"></select>
    </div>
    <div id="buttons">
      <button id="p180">180p (320x180)</button>
      <button id="qvga">QVGA (320x240)</button>
      <button id="p360">360p (640x360)</button>
      <button id="vga">VGA (640x480)</button>
      <button id="hd">HD/720p (1280x720)</button>
      <button id="full-hd">Full HD/1080p (1920x1080)</button>
      <button id="televisionFourK">Television 4K/2160p (3840x2160)</button>
      <button id="cinemaFourK">Cinema 4K (4096x2160)</button>
      <button id="eightK">8K</button>
    </div>
    <div id="videoblock">
      <p id="dimensions"></p>
      <video id="gum-res-local" playsinline autoplay></video>
      <div id="width">
        <label>Width <span></span>px:</label>
        <input type="range" min="0" max="7680" value="0" />
      </div>
      <input id="sizelock" type="checkbox" />Lock video size<br />
      <input id="aspectlock" type="checkbox" />Lock aspect ratio<br />
      <input id="pausevideo" type="checkbox" />Pause video<br />
    </div>
    <p id="errormessage"></p>
  </div>
</body>

</html>
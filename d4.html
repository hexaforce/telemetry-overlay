<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>D3 Radial Gauge - Display Current Value</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
      svg {
        background: #f8f8f8;
      }
    </style>
  </head>
  <body>
    <svg id="gauge" width="250" height="250"></svg>
    <script>
      const width = 240
      const height = 240
      const radius = 115
      let currentValue = 0
      let step = 5

      const svg = d3 //
        .select('#gauge')
        .attr('width', width)
        .attr('height', height)
        .append('g')
        .attr('transform', `translate(${width / 2}, ${height / 2})`) // 位置を上へ

      // スケール（0~270° に対応）
      const scale = d3.scaleLinear().domain([0, 270]).range([-135, 135])

      // 目盛とラベルの両方を 90° 反時計回りにずらす
      const tickOffset = 90 // 90° ずらす

      // 背景の塗りつぶしアーク（溜まっていくようなイメージ）
      const filledArc = svg
        .append('path')
        .attr('fill', '#4CAF50') // 初期は緑
        .attr('opacity', 0.7)

      // 現在の値を表示するテキスト
      const valueText = svg
        .append('text')
        .attr('x', 0)
        .attr('y', 20) // 針の根元付近に表示
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('fill', '#000')
        .style('font-size', '18px')
        .style('font-weight', 'bold')
        .text(currentValue) // 初期値

      // 細かい目盛 (5刻み)
      const fineTickValues = d3.range(0, 271, 5)
      fineTickValues.forEach((value) => {
        const angle = (scale(value) - tickOffset) * (Math.PI / 180) // 90° ずらす

        // 細かい目盛の線（短め）
        const x1 = Math.cos(angle) * (radius - 15)
        const y1 = Math.sin(angle) * (radius - 15)
        const x2 = Math.cos(angle) * (radius - 10)
        const y2 = Math.sin(angle) * (radius - 10)

        svg
          .append('line')
          .attr('x1', x1)
          .attr('y1', y1)
          .attr('x2', x2)
          .attr('y2', y2)
          .attr('stroke', '#666') // 色を薄めに
          .attr('stroke-width', 1)
      })

      // 太い目盛 (30刻み)
      const tickValues = d3.range(0, 271, 30)
      tickValues.forEach((value) => {
        const angle = (scale(value) - tickOffset) * (Math.PI / 180) // 90° ずらす

        // 太い目盛の線（長め）
        const x1 = Math.cos(angle) * (radius - 20)
        const y1 = Math.sin(angle) * (radius - 20)
        const x2 = Math.cos(angle) * (radius - 5)
        const y2 = Math.sin(angle) * (radius - 5)

        svg //
          .append('line')
          .attr('x1', x1)
          .attr('y1', y1)
          .attr('x2', x2)
          .attr('y2', y2)
          .attr('stroke', '#333')
          .attr('stroke-width', 2)

        // 数値ラベル
        const xText = Math.cos(angle) * (radius - 40)
        const yText = Math.sin(angle) * (radius - 30)

        svg //
          .append('text')
          .attr('x', xText)
          .attr('y', yText)
          .attr('text-anchor', 'middle')
          .attr('dominant-baseline', 'middle')
          .attr('fill', '#000')
          .style('font-size', '14px')
          .text(value)
      })

      // 針
      const needle = svg //
        .append('g')
        .attr('transform', `rotate(${scale(currentValue)})`)

      needle
        .append('line')
        .attr('x1', 0)
        .attr('y1', 0)
        .attr('x2', 0)
        .attr('y2', -radius + 15)
        .attr('stroke', 'red')
        .attr('stroke-width', 4)

      // 値を更新
      function updateGauge(v) {
        let value = v < 0 ? 0 : v
        needle
          .transition()
          .duration(80)
          .ease(d3.easeLinear)
          .attr('transform', `rotate(${scale(v)})`)

        // 現在の値を更新
        valueText.text(v)

        // 背景の塗りつぶしを更新
        filledArc
          .transition()
          .duration(80)
          .attr(
            'd',
            d3.arc()({
              innerRadius: radius - 15,
              outerRadius: radius,
              startAngle: (-Math.PI * 3) / 4, // 135° (左端)
              endAngle: scale(value) * (Math.PI / 180), // 現在の値に応じたエンド角度
            }),
          )
      }

      // 100ms ごとに5ずつ増やし、270を超えたら-20ずつ行い0になったらまた5ずつ増やす
      setInterval(() => {
        currentValue += step

        if (currentValue >= 270) {
          step = -20 // 270 を超えたら減少
        } else if (currentValue <= 0) {
          step = 5 // 0 になったら再び増加
        }

        updateGauge(currentValue)
      }, 150)
    </script>
  </body>
</html>

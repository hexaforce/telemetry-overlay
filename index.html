<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <link href="//api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet" />
    <script type="module" type="text/javascript">
      'use strict'

      // const sensor = new AbsoluteOrientationSensor();
      console.log(window)

      const params = new URLSearchParams(window.location.search)
      const protocol = params.get('protocol')

      import { setSenderPriority, setupReceiverTransform, isIPv4, toICE, requestPermission } from './Support.js'
      import { getDevices } from './Device.js'
      import { StreamVisualizer } from './StreamVisualizer.js'
      import { reportAggregate } from './Report.js'
      import { fixH264Codecs, preferredCodecs } from './Codec.js'
      import { SupportedType, MultimediaRecorder } from './MultimediaRecorder.js'
      import { renderMap } from './NavigationMap.js'
      import { chartBar } from './RealtimeChart.js'

      const recorder = new MultimediaRecorder()

      WebSocket.prototype.originalSend = WebSocket.prototype.send
      WebSocket.prototype.send = function (type, ws1Id, ws2Id, data) {
        this.originalSend(JSON.stringify({ type, ws1Id, ws2Id, ...data }))
      }

      RTCDataChannel.prototype.originalSend = RTCDataChannel.prototype.send
      RTCDataChannel.prototype.send = function (type, data) {
        this.originalSend(JSON.stringify({ type, ...data }))
      }

      if (!!!window.RTCRtpScriptTransform) {
        const stream = new ReadableStream()
        window.postMessage(stream, '*', [stream])
      }

      let startTime
      let ws1
      let pc1
      if (protocol === 'transceiver') {
        ws1 = new WebSocket('wss://SERVER_IP_ADDRESS/ws', protocol)
        pc1 = new RTCPeerConnection()
        document.querySelector('.receiver').style.display = 'none'
      }
      let ws2
      let pc2
      if (protocol === 'receiver') {
        ws2 = new WebSocket('wss://SERVER_IP_ADDRESS/ws', protocol)
        pc2 = new RTCPeerConnection()
        document.querySelector('.transceiver').style.display = 'none'
        document.querySelector('.device').style.display = 'none'
        document.querySelector('.recordding').style.display = 'none'
        chartBar('div#barChart')
      }

      let dc1
      let dc2

      const localCandidateAddress = {}
      const remoteCandidateAddress = {}

      if (pc1) {
        pc1.oniceconnectionstatechange = (event) => {
          console.log('ICE State Changed:', pc1.iceConnectionState)
          if ('connected' === pc1.iceConnectionState) {
            startTime = window.performance.now()
          }
        }
        pc1.onicecandidate = ({ candidate }) => {
          if (candidate) {
            if (isIPv4(candidate.address)) {
              ws1.send('ice', ws1.id, ws1.pair, { candidate })
            }
          }
        }
        dc1 = pc1.createDataChannel('pc1')
        dc1.onopen = () => {
          console.log('DataChannel open pc1')
          dc1.onmessage = ({ data }) => {
            const message = JSON.parse(data)
            console.log('DataChannel1 message:', message)
            const { type } = message
            if (type === 'position') {
              //
              window.navigator.geolocation.getCurrentPosition(
                ({ coords, timestamp }) => dc1.send('position', { coords, timestamp }),
                (err) => console.error('Error:', err),
              )
              //
            } else if (type === 'hangup') {
              //
              window.stream.getTracks().forEach((track) => track.stop())
              //
            }
          }
        }
      }

      if (pc2) {
        pc2.oniceconnectionstatechange = (event) => {
          console.log('ICE State Changed:', pc2.iceConnectionState)
          if ('connected' === pc2.iceConnectionState) {
            setInterval(() => {
              pc2.getStats(null).then((stats) => {
                let result = reportAggregate(stats, remoteCandidateAddress, localCandidateAddress)
                document.querySelector('pre#report').innerHTML = JSON.stringify(result, null, 2)
              })
            }, 1000)
          }
        }
        pc2.onicecandidate = ({ candidate }) => {
          if (candidate) {
            if (isIPv4(candidate.address)) {
              const ice = toICE(candidate.candidate)
              if (ice) localCandidateAddress[ice[3]] = ice[2]
              ws2.send('ice', ws2.pair, ws2.id, { candidate })
            }
          }
        }
        pc2.ondatachannel = ({ channel }) => {
          console.log('DataChannel open pc2')
          dc2 = channel
          dc2.onmessage = ({ data }) => {
            const message = JSON.parse(data)
            console.log('DataChannel2 message:', message)
            const { type } = message
            if (type === 'position') {
              //
              console.log('position:', message.coords)
              // renderMap([msg.longitude, msg.latitude])
              //
            } else if (type === 'deviceorientation') {
              //
              console.log('deviceorientation:', message)
              //
            } else if (type === 'deviceorientationabsolute') {
              //
              console.log('deviceorientationabsolute:', message)
              //
            } else if (type === 'devicemotion') {
              //
              console.log('devicemotion:', message)
              //
            }
          }
        }
        pc2.ontrack = ({ receiver, streams, track }) => {
          if (track.kind === 'video') {
            setupReceiverTransform(receiver)
          }
          if (track.kind === 'audio') {
            new StreamVisualizer(streams[0], document.querySelector('canvas#audio')).start()
          }
          const remoteVideo = document.querySelector('video#remote')
          if (remoteVideo.srcObject !== streams[0]) {
            window.stream = remoteVideo.srcObject = streams[0]
          }
        }
      }

      if (ws1) {
        ws1.onopen = async () => {
          console.log('ws1 connected')
          ws1.onclose = () => console.log('ws1 closed')
          ws1.onmessage = async ({ data }) => {
            const message = JSON.parse(data)
            const { type, ws1Id, ws2Id } = message
            if (type === 'session') {
              //
              ws1.id = message.sessionId
              //
            } else if (type === 'init') {
              //
              let devices = await getDevices()
              ws1.send('info', ws1Id, ws2Id, { devices })
              //
            } else if (type === 'start') {
              //
              window.stream = await navigator.mediaDevices.getUserMedia(message.constraints)
              document.querySelector('video#local').srcObject = window.stream
              window.stream.getTracks().forEach((track) => pc1.addTrack(track, window.stream))
              // const [track] = ([window.track] = stream.getVideoTracks())
              // const capabilities = track.getCapabilities()
              // const settings = track.getSettings()

              setSenderPriority(pc1)
              const offer = await pc1.createOffer()
              await pc1.setLocalDescription(offer)
              ws1.pair = ws2Id
              ws1.send('offer', ws1Id, ws2Id, { offer })
              //
            } else if (type === 'answer') {
              //
              await pc1.setRemoteDescription(new RTCSessionDescription(message.answer))
              //
            } else if (type === 'ice') {
              //
              await pc1.addIceCandidate(message.candidate)
              //
            }
          }
        }
      }

      const transceivers = document.querySelector('select#transceivers')
      function changeTransceiverEntries(entries) {
        initButton.disabled = entries.length === 0
        while (transceivers.firstChild) transceivers.removeChild(transceivers.firstChild)
        entries.forEach((value) => {
          const option = document.createElement('option')
          option.value = value
          option.innerText = value
          transceivers.appendChild(option)
        })
      }

      const videoSelect = document.querySelector('select#videoSource')
      const audioSelect = document.querySelector('select#audioSource')
      function updateDeviceList(devices) {
        while (videoSelect.firstChild) videoSelect.removeChild(videoSelect.firstChild)
        while (audioSelect.firstChild) audioSelect.removeChild(audioSelect.firstChild)
        devices.forEach(({ deviceId, kind, label }) => {
          const option = document.createElement('option')
          option.value = deviceId
          if (kind === 'videoinput') {
            option.text = label || `Camera ${videoSelect.length + 1}`
            videoSelect.appendChild(option)
          } else if (kind === 'audioinput') {
            option.text = label || `Microphone ${audioSelect.length + 1}`
            audioSelect.appendChild(option)
          }
        })
      }

      if (ws2) {
        ws2.onopen = () => {
          console.log('ws2 connected')
          ws2.onclose = () => console.log('ws2 closed')
          ws2.onmessage = async ({ data }) => {
            const message = JSON.parse(data)
            const { type, ws1Id, ws2Id } = message
            if (type === 'session') {
              //
              ws2.id = message.sessionId
              changeTransceiverEntries(message.transceivers)
              //
            } else if (type === 'change') {
              //
              changeTransceiverEntries(message.transceivers)
              //
            } else if (type === 'info') {
              //
              updateDeviceList(message.devices)
              document.querySelector('.device').style.display = 'block'
              //
            } else if (type === 'offer') {
              //
              await pc2.setRemoteDescription(new RTCSessionDescription(message.offer))
              fixH264Codecs(pc2.getTransceivers())
              preferredCodecs(pc2.getTransceivers())
              const answer = await pc2.createAnswer()
              await pc2.setLocalDescription(answer)
              ws2.send('answer', ws1Id, ws2Id, { answer })
              ws2.pair = ws1Id
              //
            } else if (type === 'ice') {
              //
              const ice = toICE(message.candidate.candidate)
              if (ice) remoteCandidateAddress[ice[3]] = ice[2]
              await pc2.addIceCandidate(message.candidate)
              //
            }
          }
        }
      }

      // init
      // ------------------------------------------------------
      async function init() {
        ws2.send('init', transceivers.value, ws2.id)
      }
      const initButton = document.getElementById('initButton')
      initButton.onclick = init

      // start
      // ------------------------------------------------------
      async function start() {
        const constraints = {
          video: {
            frameRate: { ideal: 30, max: 60 },
            width: { ideal: 1920 },
            height: { ideal: 1080 },
            deviceId: {
              ideal: videoSelect.value,
            },
          },
          audio: {
            echoCancellation: document.querySelector('input#echoCancellation').checked,
            noiseSuppression: document.querySelector('input#noiseSuppression').checked,
            autoGainControl: document.querySelector('input#noiseSuppression').checked,
            deviceId: { ideal: audioSelect.value },
          },
        }
        ws2.send('start', transceivers.value, ws2.id, { constraints })

        SupportedType.forEach((mimeType) => {
          const option = document.createElement('option')
          option.value = mimeType.value
          option.innerText = mimeType.label
          codecPreferences.appendChild(option)
        })
      }

      // hangup
      // ------------------------------------------------------
      async function hangup() {
        dc2.send('hangup')
        window.stream.getTracks().forEach((track) => track.stop())
      }

      const controleButton = document.querySelector('button#controleButton')
      controleButton.onclick = async () => {
        if (controleButton.textContent === 'Start') {
          start()

          controleButton.textContent = 'Hang Up'
          document.querySelector('.recordding').style.display = 'block'
        } else {
          hangup()

          controleButton.textContent = 'Start'
          document.querySelector('.recordding').style.display = 'none'
        }
      }

      const codecPreferences = document.querySelector('select#codecPreferences')

      const recordButton = document.querySelector('button#record')
      recordButton.onclick = async () => {
        if (recordButton.textContent === 'Start Recording') {
          // ------------------------------------------------------
          const mimeType = codecPreferences.options[codecPreferences.selectedIndex].value
          if (mimeType.split(';', 1)[0] === 'video/mp4') {
            // Adjust sampling rate to 48khz.
            const track = window.stream.getAudioTracks()[0]
            // const [track] = ([window.track] = stream.getAudioTracks())
            // const capabilities = track.getCapabilities()
            // const settings = track.getSettings()
            if (track) {
              const { sampleRate } = track.getSettings()
              if (sampleRate != 48000) {
                track.stop()
                window.stream.removeTrack(track)
                const newStream = await navigator.mediaDevices.getUserMedia({ audio: { sampleRate: 48000 } })
                window.stream.addTrack(newStream.getTracks()[0])
              }
            }
          }
          recorder.start(window.stream, mimeType)

          recordButton.textContent = 'Stop Recording'
          playButton.disabled = true
          downloadButton.disabled = true
          codecPreferences.disabled = true
        } else {
          // ------------------------------------------------------
          recorder.stop()

          recordButton.textContent = 'Start Recording'
          playButton.disabled = false
          downloadButton.disabled = false
          codecPreferences.disabled = false
        }
      }

      const playButton = document.querySelector('button#play')
      playButton.onclick = () => recorder.play(document.querySelector('video#recordedPlay'))

      const downloadButton = document.querySelector('button#download')
      downloadButton.onclick = () => recorder.download('test')

      document.querySelector('button#positionButton').onclick = async () => dc2.send('position')
      document.querySelector('button#testButton').onclick = async () => requestPermission(dc1)
    </script>
    <style>
      .side {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .session {
        display: flex;
        flex-direction: column;
        gap: 10px;
        /* max-width: 300px; */
      }

      .device {
        display: flex;
        flex-direction: column;
        gap: 10px;
        /* max-width: 300px; */
      }

      .recordding {
        display: flex;
        flex-direction: column;
        gap: 10px;
        /* max-width: 300px; */
      }

      /* --- chart -------------------------- */

      svg {
        font: 10px sans-serif;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .x.axis line {
        shape-rendering: auto;
      }

      .line {
        fill: none;
        stroke: #000;
        stroke-width: 1.5px;
      }

      .bar {
        fill: steelblue;
      }

      .grid-line {
        stroke: lightgray;
        stroke-width: 0.5;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="transceiver">
        <p>LocalVideo</p>
        <video id="local" playsinline autoplay muted></video>
        <button id="testButton">test</button>
      </div>

      <div class="receiver">
        <div class="session">
          <div class="side">
            <label for="transceivers">Transceiver:</label>
            <select id="transceivers"></select>
            <button id="initButton">Init</button>
          </div>
          <div class="device">
            <div class="side">
              <label for="videoSource">Video source:</label
              ><select id="videoSource"></select>
            </div>
            <div class="side">
              <label for="audioSource">Audio source:</label
              ><select id="audioSource"></select>
            </div>
            <div class="side"><label for="echoCancellation">Echo Cancellation:</label><input type="checkbox" id="echoCancellation" checked /></div>
            <div class="side"><label for="noiseSuppression">Noise Suppression:</label><input type="checkbox" id="noiseSuppression" checked /></div>
            <div class="side"><label for="autoGainControl">Auto GainControl:</label><input type="checkbox" id="autoGainControl" checked /></div>
            <button id="controleButton">Start</button>
          </div>
        </div>
        <div class="recordding">
          <label for="codecPreferences">Recording format:</label>
          <select id="codecPreferences"></select>
          <button id="record">Start Recording</button>
          <button id="play">Play</button>
          <button id="download">Download</button>
        </div>

        <p>RemoteVideo</p>
        <video id="remote" playsinline autoplay muted></video>
        <video id="recordedPlay" playsinline loop></video>
        <canvas id="audio"></canvas>
        <div id="barChart"></div>
        <pre id="report"></pre>

        <button id="positionButton">position</button>
      </div>
    </div>
  </body>
</html>

<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Peer connection as input to Web Audio</title>
  <script type="module" type="text/javascript">

    'use strict'

    import { StreamVisualizer } from './StreamVisualizer.js'

    const startButton = document.getElementById('startButton')
    const callButton = document.getElementById('callButton')
    const hangupButton = document.getElementById('hangupButton')
    callButton.disabled = true
    hangupButton.disabled = true

    // startButton
    // ------------------------------------------------------
    startButton.onclick = () => {
      startButton.disabled = true

      navigator.mediaDevices
        .getUserMedia({
          video: { frameRate: { ideal: 30, max: 60 }, width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: { echoCancellation: true, noiseSuppression: true }
        })
        .then((stream) => {
          localVideo.srcObject = stream
          localStream = stream
          callButton.disabled = false
        })
        .catch((e) => alert(`getUserMedia() error: ${e.name}`))

    }

    // callButton
    // ------------------------------------------------------
    callButton.onclick = () => {
      callButton.disabled = true
      hangupButton.disabled = false

      // const videoTracks = localStream.getVideoTracks()
      // const audioTracks = localStream.getAudioTracks()

      pc1 = new RTCPeerConnection()
      pc1.onicecandidate = ({ candidate }) => pc2.addIceCandidate(candidate)
      pc2 = new RTCPeerConnection()
      pc2.onicecandidate = ({ candidate }) => pc1.addIceCandidate(candidate)
      pc2.ontrack = ({ streams }) => {
        if (remoteVideo.srcObject !== streams[0]) {
          remoteVideo.srcObject = streams[0]
          const streamVisualizer = new StreamVisualizer(streams[0], canvas)
          streamVisualizer.start()
        }
      }
      localStream.getTracks().forEach((track) => pc1.addTrack(track, localStream))
      pc1.createOffer({
        offerToReceiveAudio: 1,
        offerToReceiveVideo: 1,
      }).then((desc) => {
        pc1.getSenders().forEach((s) => {
          if (s.track.kind === "video") {
            const p = s.getParameters()
            if (p.encodings.length > 0) {
              // p.encodings[0].priority = "high"
              p.encodings[0].networkPriority = "high"
              // p.encodings[0].maxBitrate = 10000000
            }
            s.setParameters(p)
          }
        })
        pc1.setLocalDescription(desc)
        pc2.setRemoteDescription(desc)
        pc2.createAnswer().then((desc) => {
          pc2.setLocalDescription(desc)
          pc1.setRemoteDescription(desc)
        })
      })
    }

    // hangupButton
    // ------------------------------------------------------
    hangupButton.onclick = () => {
      console.log('Ending call')
      pc1.close()
      pc2.close()
      pc1 = null
      pc2 = null
      hangupButton.disabled = true
      callButton.disabled = false
    }

    const canvas = document.querySelector('canvas')

    const localVideo = document.getElementById('localVideo')
    const remoteVideo = document.getElementById('remoteVideo')

    let localStream
    let pc1
    let pc2
    const offerOptions = {
      offerToReceiveAudio: 1,
      offerToReceiveVideo: 1,
    }

  </script>
</head>

<body>
  <div id="container">
    <p>localVideo</p>
    <video id="localVideo" playsinline autoplay muted></video>
    <p>remoteVideo</p>
    <video id="remoteVideo" playsinline autoplay muted></video>
    <canvas></canvas>
    <div>
      <button id="startButton">Start</button>
      <button id="callButton">Call</button>
      <button id="hangupButton">Hang Up</button>
    </div>
  </div>
</body>

</html>
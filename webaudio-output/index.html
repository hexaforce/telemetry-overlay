<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Peer connection as input to Web Audio</title>
  <script type="module" type="text/javascript">

    'use strict'

    import { StreamVisualizer } from './StreamVisualizer.js'

    const startButton = document.getElementById('startButton')
    const callButton = document.getElementById('callButton')
    const hangupButton = document.getElementById('hangupButton')
    callButton.disabled = true
    hangupButton.disabled = true

    // startButton
    // ------------------------------------------------------
    startButton.onclick = async () => {
      startButton.disabled = true

      const stream = await navigator.mediaDevices.getUserMedia({
        video: { frameRate: { ideal: 30, max: 60 }, width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: { echoCancellation: true, noiseSuppression: true }
      })
      localVideo.srcObject = stream
      localStream = stream
      callButton.disabled = false
    }

    // callButton
    // ------------------------------------------------------
    callButton.onclick = async () => {
      callButton.disabled = true
      hangupButton.disabled = false

      pc1 = new RTCPeerConnection()
      pc1.onicecandidate = ({ candidate }) => pc2.addIceCandidate(candidate)
      pc2 = new RTCPeerConnection()
      pc2.onicecandidate = ({ candidate }) => pc1.addIceCandidate(candidate)

      pc2.ontrack = ({ streams }) => {
        if (remoteVideo.srcObject !== streams[0]) {
          remoteVideo.srcObject = streams[0]
          const streamVisualizer = new StreamVisualizer(streams[0], canvas)
          streamVisualizer.start()
        }
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        stream.getTracks().forEach(track => pc1.addTrack(track, stream))
        preferredVideoCodecs(pc1.getTransceivers())

        const offer = await pc1.createOffer({
          offerToReceiveAudio: 1,
          offerToReceiveVideo: 1,
        })

        pc1.getSenders().forEach(sender => {
          if (sender.track.kind === "video") {
            const params = sender.getParameters()
            if (params.encodings.length > 0) {
              params.encodings[0].priority = "high" // 一部のブラウザ向け
              params.encodings[0].networkPriority = "high" // 最新の仕様向け
              params.encodings[0].maxBitrate = 10 * 1000 * 1000 // ビットレート調整（必要なら）
            }
            sender.setParameters(params).catch(err => console.warn("setParameters failed:", err))
          }
        })

        await pc1.setLocalDescription(offer)
        await pc2.setRemoteDescription(offer)

        preferredVideoCodecs(pc2.getTransceivers())

        const answer = await pc2.createAnswer()
        await pc2.setLocalDescription(answer)
        await pc1.setRemoteDescription(answer)
      } catch (err) {
        console.error("WebRTC connection error:", err)
      }
    }

    function preferredVideoCodecs(transceivers) {
      const sort = (supportedCodecs, preferredOrder) => supportedCodecs.sort((a, b) => {
        const indexA = preferredOrder.indexOf(a.mimeType)
        const indexB = preferredOrder.indexOf(b.mimeType)
        const orderA = indexA >= 0 ? indexA : Number.MAX_VALUE
        const orderB = indexB >= 0 ? indexB : Number.MAX_VALUE
        return orderA - orderB
      })
      transceivers.forEach(transceiver => {
        if (transceiver.receiver.track.kind === "video") {
          const supportedCodecs = RTCRtpReceiver.getCapabilities('video').codecs
          const preferredOrder = ['video/H264', 'video/VP8', 'video/AV1', 'video/VP9', 'video/H265']
          transceiver.setCodecPreferences(sort(supportedCodecs, preferredOrder))
        }
        if (transceiver.receiver.track.kind === "audio") {
          const supportedCodecs = RTCRtpReceiver.getCapabilities('audio').codecs
          const preferredOrder = ["audio/opus", "audio/G722", "audio/PCMU", "audio/PCMA"]
          transceiver.setCodecPreferences(sort(supportedCodecs, preferredOrder))
        }
      })
    }

    // hangupButton
    // ------------------------------------------------------
    hangupButton.onclick = () => {
      console.log('Ending call')
      pc1.close()
      pc1 = null
      pc2.close()
      pc2 = null
      hangupButton.disabled = true
      callButton.disabled = false
    }

    const canvas = document.querySelector('canvas')

    const localVideo = document.getElementById('localVideo')
    const remoteVideo = document.getElementById('remoteVideo')

    let localStream
    let pc1
    let pc2
    const offerOptions = {
      offerToReceiveAudio: 1,
      offerToReceiveVideo: 1,
    }

  </script>
</head>

<body>
  <div id="container">
    <p>localVideo</p>
    <video id="localVideo" playsinline autoplay muted></video>
    <p>remoteVideo</p>
    <video id="remoteVideo" playsinline autoplay muted></video>
    <canvas></canvas>
    <div>
      <button id="startButton">Start</button>
      <button id="callButton">Call</button>
      <button id="hangupButton">Hang Up</button>
    </div>
  </div>
</body>

</html>